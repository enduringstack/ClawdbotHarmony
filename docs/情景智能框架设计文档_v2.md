# 情景智能框架设计文档 v2

## 1. 概述

ClawdBot 情景智能引擎：基于传感器数据、地理围栏、行为学习和强化学习的上下文感知推荐系统。

## 2. 架构

### 2.1 感知层
传感器数据采集：加速度计、计步器、电池、网络、GPS。

### 2.2 地理围栏
基于 GPS 的虚拟围栏，支持进入/离开事件触发。

### 2.3 行为学习
BehaviorLogger 记录用户行为，提取规则模式。

### 2.4 规则引擎
C++ NAPI 实现的高性能规则匹配 + LinUCB 上下文强盗算法。

### 2.5 传感器数据托盘 (Sensor Data Tray)

#### 概念
数据托盘是感知层和决策层之间的**缓存中间层**。传感器异步写入，引擎同步读取。

#### 数据结构
每个托盘槽位存储：
| 字段 | 类型 | 说明 |
|------|------|------|
| key | string | 传感器标识，如 "gps", "motion", "battery" |
| value | string | 最新值（统一为字符串，引擎内部解析） |
| updatedAt | number | 最后更新时间戳 (ms) |
| ttlMs | number | 存活时间（超过则标记为 stale） |
| quality | number | 数据质量 0~1（精度、可信度） |
| source | string | 来源（如 "gps", "wifi_ssid", "manual"） |

#### TTL 规则
| 传感器 | 默认 TTL | 说明 |
|--------|---------|------|
| 时间/星期 | ∞ | 永远新鲜（实时计算） |
| 电量/充电 | 5 min | 变化慢 |
| 网络类型 | 2 min | WiFi/cellular 切换 |
| 运动状态 | 30 sec | 变化快 |
| GPS 位置 | 2 min | 耗电，不宜频繁 |
| 围栏状态 | 5 min | 事件驱动 |
| 心率 | 1 min | 手表数据 |
| 环境光/噪音 | 30 sec | 变化快 |

#### 读取行为
- **新鲜** (age < TTL): 直接返回 value, quality
- **过期** (age >= TTL): 返回 value 但 quality 按时间线性衰减
  - `effective_quality = quality * max(0, 1 - (age - ttl) / ttl)`
  - 超过 2*TTL: quality = 0（视为缺失数据）
- **从未写入**: 返回 null（引擎用 0.5 作为缺失值的默认置信度）

#### 架构
```
传感器A ──→ ┌──────────────┐
传感器B ──→ │  数据托盘     │ ──→ 规则引擎 evaluate()
传感器C ──→ │  (key-value)  │ ──→ LLM fallback
围栏事件 ──→ │  + TTL + quality│
通知事件 ──→ └──────────────┘
```

## 3. 数据流

感知层 → 数据托盘 → 规则引擎 → 推荐卡片 → 用户反馈 → 强化学习
