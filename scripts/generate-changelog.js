#!/usr/bin/env node
/**
 * Generate Changelog.ets from CHANGELOG.json
 * Run before each build to keep changelog in sync.
 *
 * Also reads version from AppScope/app.json5
 */

const fs = require('fs');
const path = require('path');

const ROOT = path.resolve(__dirname, '..');
const CHANGELOG_JSON = path.join(ROOT, 'CHANGELOG.json');
const APP_JSON5 = path.join(ROOT, 'AppScope', 'app.json5');
const OUTPUT_DIR = path.join(ROOT, 'entry', 'src', 'main', 'ets', 'generated');
const OUTPUT_FILE = path.join(OUTPUT_DIR, 'Changelog.ets');

function readJson5(filePath) {
  // Simple JSON5 parser (handles trailing commas and comments)
  let content = fs.readFileSync(filePath, 'utf8');
  // Remove single-line comments
  content = content.replace(/\/\/.*$/gm, '');
  // Remove multi-line comments
  content = content.replace(/\/\*[\s\S]*?\*\//g, '');
  // Remove trailing commas before } or ]
  content = content.replace(/,(\s*[}\]])/g, '$1');
  return JSON.parse(content);
}

function main() {
  // Read changelog
  if (!fs.existsSync(CHANGELOG_JSON)) {
    console.error('CHANGELOG.json not found');
    process.exit(1);
  }
  const changelog = JSON.parse(fs.readFileSync(CHANGELOG_JSON, 'utf8'));

  // Read version from app.json5
  let appVersion = '0.0.0';
  if (fs.existsSync(APP_JSON5)) {
    try {
      const appConfig = readJson5(APP_JSON5);
      appVersion = appConfig.app?.versionName || '0.0.0';
    } catch (e) {
      console.warn('Warning: Could not parse app.json5:', e.message);
    }
  }

  // Ensure output directory exists
  if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  // Generate ArkTS code
  const entries = changelog.map(entry => {
    const features = entry.features.map(f => `      '${f.replace(/'/g, "\\'")}',`).join('\n');
    const fixes = entry.fixes.map(f => `      '${f.replace(/'/g, "\\'")}',`).join('\n');
    return `  {
    version: '${entry.version}',
    date: '${entry.date}',
    features: [
${features}
    ],
    fixes: [
${fixes}
    ],
  },`;
  }).join('\n');

  const latestVersion = changelog.length > 0 ? changelog[0].version : appVersion;

  const code = `// Auto-generated by scripts/generate-changelog.js
// DO NOT EDIT MANUALLY - Edit CHANGELOG.json instead

export interface ChangelogEntry {
  version: string;
  date: string;
  features: string[];
  fixes: string[];
}

export const APP_VERSION: string = '${appVersion}';

export const CHANGELOG: ChangelogEntry[] = [
${entries}
];

export const LATEST_VERSION: string = '${latestVersion}';
`;

  fs.writeFileSync(OUTPUT_FILE, code, 'utf8');
  console.log(`Generated ${OUTPUT_FILE}`);
  console.log(`  App version: ${appVersion}`);
  console.log(`  Changelog entries: ${changelog.length}`);
}

main();
